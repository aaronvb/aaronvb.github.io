{"componentChunkName":"component---src-templates-post-template-js","path":"/articles/setting-up-an-ubuntu-server-with-ruby-1-9-2-and-rails-3-1","result":{"data":{"markdownRemark":{"id":"d043ab4f-5fc3-5791-be0b-dc1b374384ce","html":"<p>I just recently fired up a new Linode VPS, with Ubuntu 10.04 LTS, to stage a Ruby on Rails 3.1 app running Ruby 1.9.2 and I thought I would share my process. Total time took about 1 hour. I’m also going to share my deploy method using Github and Capistrano.</p>\n<p>Just for reference, this is what’s going to be installed:</p>\n<p>Git\nRVM\nRuby 1.9.2\nRuby on Rails 3.1\nsqlite3\nApache 2\nPassenger</p>\n<p>So the first thing to do is make sure you have your Ubuntu server setup properly with SSH and and all Ubuntu updates. I followed these steps: <a href=\"https://web.archive.org/web/20180415154920/http://articles.slicehost.com/2010/4/30/ubuntu-lucid-setup-part-1\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">articles.slicehost.com/2010/4/30/ubuntu-lucid-setup-part-1</a>. Also make sure you know your root password as we’ll need to <code class=\"language-text\">su</code> back into root later on.</p>\n<p>Once you have that done, the second article should end after you update. Next install Git.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ sudo aptitude build-dep git-core\n$ mkdir ~/sources\n$ cd ~/sources\n$ wget http://git-core.googlecode.com/files/git-1.7.7.2.tar.gz\n$ tar xvzf git-1.7.7.2.tar.gz\n$ cd git-1.7.7.2\n$ ./configure\n$ make\n$ sudo make install</code></pre></div>\n<p>You can verify the installation by typing:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ git --version</code></pre></div>\n<p>After git is installed, we need to get the packages for Ruby 1.9.2 to be compatible with Rails 3.1.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ sudo apt-get install openssl libssl-dev libreadline5-dev zlib1g-dev libncurses5-dev</code></pre></div>\n<p>Next we need to log into root to install RVM.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ su\n$ bash &lt; &lt;(curl -s https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer )</code></pre></div>\n<p>Once RVM is installed, time to install Ruby 1.9.2. Make sure you’re still logged in as root(through su). You’ll need to source the RVM script every time you log into root. Normally you wont be doing this often enough to have it auto load, but you can if you want to.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ source /usr/local/rvm/scripts/rvm</code></pre></div>\n<p>Now you should have access to the command: <code class=\"language-text\">rvm</code></p>\n<p>Install packages for Ruby 1.9.2 that Rails 3.1 will require.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ rvm pkg install readline\n$ rvm pkg install iconv\n$ rvm pkg install openssl</code></pre></div>\n<p>Now you can install Ruby 1.9.2</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ rvm install 1.9.2 -C --with-openssl-dir=/usr/local/rvm/usr,--with-iconv-dir=/usr/local/rvm/usr,--with-readline-dir=/usr/local/rvm/usr</code></pre></div>\n<p>Once that’s finished, set Ruby 1.9.2 as the system default.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ rvm use 1.9.2 --default</code></pre></div>\n<p>Then exit root su.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ exit</code></pre></div>\n<p>You should be back to your normal user. Check to make sure rvm is loaded by typing ‘rvm’. If nothing happens exit SSH and log back in. At this point, Ruby should be installed:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ ruby -v\n-> ruby 1.9.2p290 (2011-07-09 revision 32553) [i686-linux]</code></pre></div>\n<p>Next install Bundler.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ rvmsudo gem install bundler</code></pre></div>\n<p>Before continuing, make sure your project is on a github repository.</p>\n<p>To be able to deploy the code from your github repo to this server, you need to have an rsa key that will be added to your github repository deploy key setting.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ cd ~/.ssh\n$ ssh-keygen -t rsa -C \"youremailaddress@whatever.com\"</code></pre></div>\n<p>Once that’s done, copy the contents of the <code class=\"language-text\">id_rsa.pub</code>key.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ cat id_rsa.pub</code></pre></div>\n<p>The output should look like: <code class=\"language-text\">ssh-rsa AASasdnl31nADLKAnrqppq...oeqnAE1== youremailaddress@whatever.com</code></p>\n<p>Copy that to your github project deploy key:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 687px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/706516fa54a9d804090ed7cdb4cb3170/abd8c/deploy_key_ss.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAECAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHdU6xjD//EABcQAQEBAQAAAAAAAAAAAAAAAAAREBL/2gAIAQEAAQUCXeUf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGhAAAwADAQAAAAAAAAAAAAAAAAEREFFhof/aAAgBAQABPyFJSpkb9L3CQk//2gAMAwEAAgADAAAAEBMP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGxABAAICAwAAAAAAAAAAAAAAAQARITFBUYH/2gAIAQEAAT8QyAuu4IcYo6v7EKSU85gOgJ//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/706516fa54a9d804090ed7cdb4cb3170/8ac56/deploy_key_ss.webp 240w,\n/static/706516fa54a9d804090ed7cdb4cb3170/d3be9/deploy_key_ss.webp 480w,\n/static/706516fa54a9d804090ed7cdb4cb3170/38668/deploy_key_ss.webp 687w\"\n          sizes=\"(max-width: 687px) 100vw, 687px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/706516fa54a9d804090ed7cdb4cb3170/09b79/deploy_key_ss.jpg 240w,\n/static/706516fa54a9d804090ed7cdb4cb3170/7cc5e/deploy_key_ss.jpg 480w,\n/static/706516fa54a9d804090ed7cdb4cb3170/abd8c/deploy_key_ss.jpg 687w\"\n          sizes=\"(max-width: 687px) 100vw, 687px\"\n          type=\"image/jpeg\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/706516fa54a9d804090ed7cdb4cb3170/abd8c/deploy_key_ss.jpg\"\n          alt=\"deploy_key\"\n          title=\"deploy_key\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<p>You can verify that you did it correctly:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ ssh -T git@github.com\n-> Hi aaronvb! You've successfully authenticated, but GitHub does not provide shell access.</code></pre></div>\n<p>Next, Ubuntu dependencies for sqlite3:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ sudo apt-get install sqlite3 libsqlite3-dev</code></pre></div>\n<p>The next steps will be on your LOCAL computer. If you already have your own way of deployment you can skip this. Install capistrano, or update to the latest version, and update to the newest bundler. The reason why you need the latest bundler is so that capistrano can work with the new asset pipeline in Rails 3.1. Let me explain how this can work.</p>\n<p>You have two options when deploying your app with the new asset pipeline. Compile your assets locally and include the files in your push to your repository, then deploy normally. Second option, push your code as you normally would to your repository, deploy, and have your assets compile on your server instead of locally. The later is the default way capistrano will handle the deploy, and in my opinion is the easiest way.</p>\n<p><code class=\"language-text\">On your LOCAL computer:</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ gem install capistrano\n$ gem install bundler</code></pre></div>\n<p>Setup capistrano in your app:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ cd your/app/\n$ capify .</code></pre></div>\n<p>Next, change capistrano settings to allow asset pipeline and RVM support. In your app directory, open up the file: <code class=\"language-text\">Capfile</code>and change it to look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">load <span class=\"token string\">'deploy'</span> <span class=\"token keyword\">if</span> respond_to<span class=\"token operator\">?</span><span class=\"token punctuation\">(</span><span class=\"token symbol\">:namespace</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># cap2 differentiator</span>\n\n<span class=\"token comment\"># Uncomment if you are using Rails' asset pipeline</span>\nload <span class=\"token string\">'deploy/assets'</span>\n\n<span class=\"token builtin\">Dir</span><span class=\"token punctuation\">[</span><span class=\"token string\">'vendor/gems/*/recipes/*.rb'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'vendor/plugins/*/recipes/*.rb'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">each</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">|</span>plugin<span class=\"token operator\">|</span> load<span class=\"token punctuation\">(</span>plugin<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n\nload <span class=\"token string\">'config/deploy'</span> <span class=\"token comment\"># remove this line to skip loading any of the default tasks</span>\n\n$<span class=\"token punctuation\">:</span><span class=\"token punctuation\">.</span>unshift<span class=\"token punctuation\">(</span><span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span>expand_path<span class=\"token punctuation\">(</span><span class=\"token string\">'./lib'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">ENV</span><span class=\"token punctuation\">[</span><span class=\"token string\">'rvm_path'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># Add RVM's lib directory to the load path.</span>\n<span class=\"token keyword\">require</span> <span class=\"token string\">\"rvm/capistrano\"</span>                  <span class=\"token comment\"># Load RVM's capistrano plugin.</span></code></pre></div>\n<p>Next configure the capistrano deploy file by opening: <code class=\"language-text\">your/app/config/deploy.rb</code>. I’ve provided my <code class=\"language-text\">deploy.rb</code> as a reference:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">set <span class=\"token symbol\">:application</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"aaronvb\"</span>\nset <span class=\"token symbol\">:repository</span><span class=\"token punctuation\">,</span>  <span class=\"token string\">\"git@github.com:aaronvb/aaronvb.git\"</span>\n\nset <span class=\"token symbol\">:deploy_to</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"~/sites/<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span>application<span class=\"token delimiter tag\">}</span></span>\"</span>\n\nset <span class=\"token symbol\">:scm</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"git\"</span>\nset <span class=\"token symbol\">:branch</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"master\"</span>\n\nset <span class=\"token symbol\">:user</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"aaronvb\"</span>\n\nrole <span class=\"token symbol\">:app</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"yourserverip:yourserverportforssh\"</span>\nrole <span class=\"token symbol\">:web</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"yourserverip:yourserverportforssh\"</span>\nrole <span class=\"token symbol\">:db</span><span class=\"token punctuation\">,</span>  <span class=\"token string\">\"yourserverip:yourserverportforssh\"</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:primary</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean\">true</span>\n\n<span class=\"token comment\"># if you're still using the script/reaper helper you will need</span>\n<span class=\"token comment\"># these http://github.com/rails/irs_process_scripts</span>\n\nnamespace <span class=\"token symbol\">:deploy</span> <span class=\"token keyword\">do</span>\n  desc <span class=\"token string\">\"Restarting Passenger with restart.txt\"</span>\n  task <span class=\"token symbol\">:restart</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:roles</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token symbol\">:app</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:except</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span> <span class=\"token symbol\">:no_release</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">do</span>\n    run <span class=\"token string\">\"touch <span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span>current_path<span class=\"token delimiter tag\">}</span></span>/tmp/restart.txt\"</span>\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token punctuation\">[</span><span class=\"token symbol\">:start</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:stop</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">each</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>t<span class=\"token operator\">|</span>\n    desc <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span>t<span class=\"token delimiter tag\">}</span></span> task is a no-op with mod_rails\"</span>\n    task t<span class=\"token punctuation\">,</span> <span class=\"token symbol\">:roles</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token symbol\">:app</span> <span class=\"token keyword\">do</span> <span class=\"token punctuation\">;</span> <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>Now to setup the directories for capistrano on  your server. <code class=\"language-text\">Still on your LOCAL computer</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ cap deploy:setup\n$ cap deploy:check\n-> You appear to have all necessary dependencies installed</code></pre></div>\n<p>Now to deploy JUST the code from your github repository:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ cap deploy:update_code</code></pre></div>\n<p>Once that finishes, go back to your SERVER. Your app should now be residing in the folder you setup within the capistrano <code class=\"language-text\">deploy.rb</code> file. Go to that directory. If you used my <code class=\"language-text\">deploy.rb</code> then it will be in <code class=\"language-text\">~/sites/yourappname/</code>.</p>\n<p>When you find it, go to <code class=\"language-text\">/releases/</code> and go to the only folder in there. It should be a folder named with numbers(datetime stamp of the latest deploy). In that folder you should see your app code from your github repository. The way capistrano works is that every time you deploy your code, it uploads it to a new folder in <code class=\"language-text\">/releases/</code> which will be named by a datetime stamp, and then linked to <code class=\"language-text\">/yourappname/current</code>.</p>\n<p>So at this point you should be sitting in your app root directory on your server. The next step is to get your apps gems installed, easy:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ bundle install</code></pre></div>\n<p>After that finishes, time to install node.js. This is required to compile the assets for the asset pipeline in Rails 3.1. If you decided to compile your assets on your local computer, you can skip this. I followed the instruction from: <a href=\"https://github.com/joyent/node/wiki/Installing-Node.js-via-package-manager\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">github.com/joyent/node/wiki/Installing-Node.js-via-package-manager</a> for this part.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ sudo apt-get install python-software-properties\n$ sudo add-apt-repository ppa:chris-lea/node.js\n$ sudo apt-get update\n$ sudo apt-get install nodejs</code></pre></div>\n<p>If you’re using sqlite as the database, you might run into a little problem when deploying. Every time you deploy, your production.db will get removed. This is because your production.db isn’t in your github repository. You have a few options to handle this; have your deploy script copy the production.db from your old release to your latest release, or place your production.db outside of your releases. I use the later option. To do this I created the folder: <code class=\"language-text\">/sites/yourappname/db/</code> and in my <code class=\"language-text\">database.yml</code> config file I changed the path for the production database to: <code class=\"language-text\">database: /home/yourserverusername/sites/yourappname/db/production.sqlite3</code>.</p>\n<p>Time to set the database up in your app. Change directories back to your project.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ rake db:create RAILS_ENV=production\n$ rake db:migrate RAILS_ENV=production</code></pre></div>\n<p>You can test your app now by trying the console: <code class=\"language-text\">$ rails c production</code>.</p>\n<p>Installing Apache 2 and Passenger:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ sudo aptitude install apache2\n$ rvmsudo gem install passenger\n$ sudo apt-get install apache2-prefork-dev\n$ sudo apt-get install libapr1-dev\n$ sudo apt-get install libaprutil1-dev\n$ rvmsudo passenger-install-apache2-module</code></pre></div>\n<p>Follow the instructions that Passenger presents after the installation. It should ask you to place a few lines of code at the bottom of <code class=\"language-text\">/etc/apache2/apache2.conf</code>.</p>\n<p>The last part is to create the virtual host for your app:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ cd /etc/apache2/sites-available\n$ sudo nano yoursite.com</code></pre></div>\n<p>Inside that file add. Note: I’m basing this off of my deploy script I provided. If you have your app in a different directory I’m sure you can figure this out. The DocumentRoot and Directory MUST point to the public folder in the /current/ folder of your capistrano deploy directory:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;VirtualHost *:80>\n  ServerAdmin admin@yourdomain.com\n  ServerName  yourdomain.com\n  ServerAlias www.yourdomain.com\n\n  DocumentRoot /home/yourserverusername/sites/yourappname/current/public\n\n  &lt;Directory /home/yourserverusername/sites/yourappname/current/public>\n    AllowOverride all\n    Options -MultiViews\n  &lt;/Directory>\n&lt;/VirtualHost></code></pre></div>\n<p>Save the file, disable and enable a few things, then restart apache2.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ sudo a2dissite default\n$ sudo a2ensite yoursite.com\n$ sudo a2enmod rewrite\n$ sudo apache2ctl restart</code></pre></div>\n<p>Hope this helps. It’s quite long and forgive me if I’ve misspelled something or skipped a step. Please let me know if you have any troubles.</p>","fields":{"slug":"/articles/setting-up-an-ubuntu-server-with-ruby-1-9-2-and-rails-3-1","tagSlugs":["/tag/dev-ops/","/tag/ruby-on-rails/","/tag/linux/"]},"frontmatter":{"date":"2011-09-24","description":"I just recently fired up a new Linode VPS, with Ubuntu 10.04 LTS, to stage a Ruby on Rails 3.1 app running Ruby 1.9.2 and I thought I would share my process.","tags":["DevOps","Ruby on Rails","Linux"],"title":"Setting up an Ubuntu server with Ruby 1.9.2 and Rails 3.1","legacyArticleId":"38"}}},"pageContext":{"slug":"/articles/setting-up-an-ubuntu-server-with-ruby-1-9-2-and-rails-3-1"}},"staticQueryHashes":["2255556206","251939775","401334301"]}
{"componentChunkName":"component---src-templates-post-template-js","path":"/articles/a-polymorphic-join-table","result":{"data":{"markdownRemark":{"id":"f2adab55-ba65-5e8d-a330-3520722b46e8","html":"<p>Here’s an interesting problem I ran into today.</p>\n<p>Polymorphic associations in Ruby on Rails are actually quite easy to do, especially in Rails 3.2. If you need a refresher, there’s a great screencast over at Railscasts, which does require a subscription which I highly highly recommend: <a href=\"http://railscasts.com/episodes/154-polymorphic-association-revised\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">railscasts.com/episodes/154-polymorphic-association-revised</a>.</p>\n<p>However, my problem was a little different, and maybe a special case because I can’t think of many applications this would apply to.</p>\n<p>Say I have a Location and a Checkpoint, and the Location and Checkpoint can have notes, posted by Users. I would use a polymorphic association for the Notes to the Location and Checkpoint. But, I also want a single Note, to be posted to many Locations or Checkpoints, which for a single model-to-model relationship I could simply use a join table.</p>\n<p>Example, two Locations which are near each other, maybe they’re coordinates, could share a single Note describing the general area, and with the same Note model, one Note may describe multiple Checkpoints.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 300px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f3436e32e8e827999fa172b04233f0bf/f93b5/polymorphic_join_table_example_1.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 87.91666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAASABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe4mjLYUKD//xAAWEAEBAQAAAAAAAAAAAAAAAAARIAD/2gAIAQEAAQUCgxH/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAUEAEAAAAAAAAAAAAAAAAAAAAw/9oACAEBAAY/Ah//xAAcEAACAQUBAAAAAAAAAAAAAAAAAREQIUFRcZH/2gAIAQEAAT8huYH2DT8FJDRkKv8A/9oADAMBAAIAAwAAABDjDwD/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/EB//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/EB//xAAeEAEBAAMAAQUAAAAAAAAAAAABEQAhMZEQQVGB8P/aAAgBAQABPxCUJs9yd+8t0qzxl0nDi5awLxfjCSkuk+ZnUXGnDxgAa9P/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/f3436e32e8e827999fa172b04233f0bf/8ac56/polymorphic_join_table_example_1.webp 240w,\n/static/f3436e32e8e827999fa172b04233f0bf/c85cb/polymorphic_join_table_example_1.webp 300w\"\n          sizes=\"(max-width: 300px) 100vw, 300px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/f3436e32e8e827999fa172b04233f0bf/09b79/polymorphic_join_table_example_1.jpg 240w,\n/static/f3436e32e8e827999fa172b04233f0bf/f93b5/polymorphic_join_table_example_1.jpg 300w\"\n          sizes=\"(max-width: 300px) 100vw, 300px\"\n          type=\"image/jpeg\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/f3436e32e8e827999fa172b04233f0bf/f93b5/polymorphic_join_table_example_1.jpg\"\n          alt=\"example_1\"\n          title=\"example_1\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<p>Solution: Make the join table polymorphic.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 400px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ae6dd7bb0e630352b84b8e0311d85017/066f9/polymorphic_join_table_example_2.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdxqhFh//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGBABAAMBAAAAAAAAAAAAAAAAAQAQEYH/2gAIAQEAAT8hewayFf/aAAwDAQACAAMAAAAQsA//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAaEAEAAwEBAQAAAAAAAAAAAAABABEhMRCB/9oACAEBAAE/EElt/EVE13FltHYm8x5cNDt2+f/Z'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/ae6dd7bb0e630352b84b8e0311d85017/8ac56/polymorphic_join_table_example_2.webp 240w,\n/static/ae6dd7bb0e630352b84b8e0311d85017/7f61c/polymorphic_join_table_example_2.webp 400w\"\n          sizes=\"(max-width: 400px) 100vw, 400px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/ae6dd7bb0e630352b84b8e0311d85017/09b79/polymorphic_join_table_example_2.jpg 240w,\n/static/ae6dd7bb0e630352b84b8e0311d85017/066f9/polymorphic_join_table_example_2.jpg 400w\"\n          sizes=\"(max-width: 400px) 100vw, 400px\"\n          type=\"image/jpeg\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/ae6dd7bb0e630352b84b8e0311d85017/066f9/polymorphic_join_table_example_2.jpg\"\n          alt=\"example_2\"\n          title=\"example_2\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<p>Notes model that contains the content and user_id, which I use to associate the User model with.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">CreateNotes</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ActiveRecord</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Migration</span>\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">change</span></span>\n    create_table <span class=\"token symbol\">:notes</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>t<span class=\"token operator\">|</span>\n      t<span class=\"token punctuation\">.</span>text <span class=\"token symbol\">:content</span>\n      t<span class=\"token punctuation\">.</span>integer <span class=\"token symbol\">:user_id</span>\n      t<span class=\"token punctuation\">.</span>timestamps\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>Note join model that is also polymorphic. notable<em>id and notable</em>type is the polymorphic attributes used by ActiveRecord.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">CreateNoteJoins</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ActiveRecord</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Migration</span>\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">change</span></span>\n    create_table <span class=\"token symbol\">:note_joins</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>t<span class=\"token operator\">|</span>\n      t<span class=\"token punctuation\">.</span>integer <span class=\"token symbol\">:note_id</span>\n      t<span class=\"token punctuation\">.</span>integer <span class=\"token symbol\">:notable_id</span>\n      t<span class=\"token punctuation\">.</span>string  <span class=\"token symbol\">:notable_type</span>\n      t<span class=\"token punctuation\">.</span>timestamps\n    <span class=\"token keyword\">end</span>\n    add_index <span class=\"token symbol\">:note_joins</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token symbol\">:notable_id</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:notable_type</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>Next I add the model associations to Location and Checkpoint models.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Location</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ActiveRecord</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Base</span>\n  has_many <span class=\"token symbol\">:note_joins</span><span class=\"token punctuation\">,</span> as<span class=\"token punctuation\">:</span> <span class=\"token symbol\">:notable</span>\n  has_many <span class=\"token symbol\">:notes</span><span class=\"token punctuation\">,</span> through<span class=\"token punctuation\">:</span> <span class=\"token symbol\">:note_joins</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Checkpoint</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ActiveRecord</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Base</span>\n  has_many <span class=\"token symbol\">:note_joins</span><span class=\"token punctuation\">,</span> as<span class=\"token punctuation\">:</span> <span class=\"token symbol\">:notable</span>\n  has_many <span class=\"token symbol\">:notes</span><span class=\"token punctuation\">,</span> through<span class=\"token punctuation\">:</span> <span class=\"token symbol\">:note_joins</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>Above I set the note<em>joins model as the polymorphic association :notable, which will use the notable</em>id and notable<em>type attributes to assign which model and ID the note join belongs to. Then I set the has</em>many association on the Note model, through note_joins. This will let me use such methods as Location.first.notes to pull up all the notes that belong to that location. The same applies to Checkpoint.</p>\n<p>In the NoteJoin model I need specify that it belongs to the notable polymorphic association and that it also belongs to a Note. I do so by adding the following.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">NoteJoin</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ActiveRecord</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Base</span>\n  belongs_to <span class=\"token symbol\">:notable</span><span class=\"token punctuation\">,</span> polymorphic<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span>\n  belongs_to <span class=\"token symbol\">:note</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>Now for the Note model, it should belong to the notable polymorphic association, and also belong to a user(through the user_id attribute).</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Note</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ActiveRecord</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Base</span>\n  attr_accessible <span class=\"token symbol\">:content</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:user_id</span>\n  belongs_to <span class=\"token symbol\">:notable</span><span class=\"token punctuation\">,</span> polymorphic<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span>\n  belongs_to <span class=\"token symbol\">:user</span>\n\n  has_many <span class=\"token symbol\">:note_joins</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>At this point everything should work, and through the NoteJoin model I can have a single Note belong to many different Locations and even Checkpoints.</p>\n<p>Let’s quickly test this in console.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token operator\">></span> <span class=\"token constant\">Location</span><span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">.</span>notes<span class=\"token punctuation\">.</span>create<span class=\"token punctuation\">(</span>user_id<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> content<span class=\"token punctuation\">:</span> <span class=\"token string\">\"foobar\"</span><span class=\"token punctuation\">)</span>\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token comment\">#&lt; Note id: 1, content: \"foobar\", user_id: 1, created_at: \"2012-11-30 02:19:24\", updated_at: \"2012-11-30 02:19:24\" ></span>\n<span class=\"token operator\">></span> <span class=\"token constant\">Location</span><span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">.</span>notes\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token comment\">#&lt; Note id: 1, content: \"foobar\", user_id: 1, created_at: \"2012-11-30 02:19:24\", updated_at: \"2012-11-30 02:19:24\" >]</span></code></pre></div>\n<p>Great it works, but now I want to see what Locations or Checkpoints this Note belongs to through NoteJoin. To do that I need to update my Note model to include a has<em>many locations and checkpoints. Notice I’m using the source and source</em>type option, to pass my polymorphic association :notable, since that’s how we translate which model it belongs to.</p>\n<script src=\"https://gist.github.com/4173290.js?file=revised_note.rb\"></script>\n<p>And now I can find the locations which my note belongs to.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token operator\">></span> <span class=\"token constant\">Note</span><span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">.</span>locations\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token comment\">#&lt; Location id: 1, name: \"foobar\", created_at: \"2012-11-30 02:19:24\", updated_at: \"2012-11-30 02:19:24\" >]</span></code></pre></div>\n<p>Another problem came up after this point. If I were to create a Note, how could I easily add many Locations to it? My first thought was to create a method that would update the join table, but I knew there had to be an easier way already built in ActiveRecord to do this.</p>\n<p>I did some digging around and found a simple solution:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token operator\">></span> note <span class=\"token operator\">=</span> <span class=\"token constant\">Note</span><span class=\"token punctuation\">.</span>create<span class=\"token punctuation\">(</span>user_id<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> content<span class=\"token punctuation\">:</span> <span class=\"token string\">\"foobar2\"</span><span class=\"token punctuation\">)</span>\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token comment\">#&lt; Note id: 2, content: \"foobar2\", user_id: 1, created_at: \"2012-11-30 02:19:24\", updated_at: \"2012-11-30 02:19:24\" ></span>\n<span class=\"token operator\">></span> <span class=\"token constant\">Location</span><span class=\"token punctuation\">.</span>all<span class=\"token punctuation\">.</span><span class=\"token keyword\">each</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>location<span class=\"token operator\">|</span>\n     note<span class=\"token punctuation\">.</span>locations <span class=\"token operator\">&lt;</span><span class=\"token operator\">&lt;</span> location\n   <span class=\"token keyword\">end</span></code></pre></div>\n<p>I’m using &#x3C;&#x3C; to push location objects into the note.locations array, and ActiveRecord will handle the creation of the NoteJoin record. Pretty neat.</p>","fields":{"slug":"/articles/a-polymorphic-join-table","tagSlugs":["/tag/code/","/tag/ruby-on-rails/","/tag/polymorphism/"]},"frontmatter":{"date":"2012-11-29","description":"Not your ordinary polymorphic association, but a polymoprhic join table for Ruby on Rails.","tags":["Code","Ruby on Rails","Polymorphism"],"title":"A Polymorphic Join Table","legacyArticleId":"44"}}},"pageContext":{"slug":"/articles/a-polymorphic-join-table"}},"staticQueryHashes":["2255556206","251939775","401334301"]}
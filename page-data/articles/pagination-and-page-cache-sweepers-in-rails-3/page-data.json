{"componentChunkName":"component---src-templates-post-template-js","path":"/articles/pagination-and-page-cache-sweepers-in-rails-3","result":{"data":{"markdownRemark":{"id":"279d7cfc-f102-5cda-bdbb-7fd8b8d1bfb2","html":"<p>This is how I handle page cache sweeping in Ruby on Rails 3.1 with pagination. This should work with earlier versions of Ruby on Rails.</p>\n<p>First of all, I’m using the <code class=\"language-text\">gem 'will_paginate', '~> 3.0'</code> and have my routes setup to match the url and replace the <code class=\"language-text\">?page=</code> with <code class=\"language-text\">/page/2</code>.</p>\n<p>In routes.rb:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">match <span class=\"token string\">'/articles/page/:page'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">'articles#index'</span></code></pre></div>\n<p>So now you want to do page caching on your site, but the problem is you can’t sweep the folder and the page numbers inside of them normally within the sweeper.</p>\n<p>For example, you have your index action which uses pagination:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">index</span></span>\n  <span class=\"token variable\">@articles</span> <span class=\"token operator\">=</span> <span class=\"token constant\">Article</span><span class=\"token punctuation\">.</span>paginate<span class=\"token punctuation\">(</span><span class=\"token symbol\">:page</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> params<span class=\"token punctuation\">[</span><span class=\"token symbol\">:page</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:per_page</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:conditions</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span><span class=\"token symbol\">:published</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:order</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token string\">'created_at DESC'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>and have it properly cached and watched by the sweeper:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">caches_page <span class=\"token symbol\">:index</span>\ncache_sweeper <span class=\"token symbol\">:article_sweeper</span></code></pre></div>\n<p>When the pages get cached, they’ll be placed in <code class=\"language-text\">/public/articles/page/1.html</code> and so forth. The problem is getting the sweeper to delete the pages when there’s a change to the Article model.</p>\n<p>Solution: Manually remove each page on the sweep.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ArticleSweeper</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ActionController</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Caching</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Sweeper</span>\n  observe <span class=\"token constant\">Article</span> <span class=\"token comment\"># This sweeper is going to keep an eye on the article model</span>\n\n  <span class=\"token comment\"># If our sweeper detects that a article was created call this</span>\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">after_create</span></span><span class=\"token punctuation\">(</span>article<span class=\"token punctuation\">)</span>\n    expire_cache_for<span class=\"token punctuation\">(</span>article<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token comment\"># If our sweeper detects that a article was updated call this</span>\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">after_update</span></span><span class=\"token punctuation\">(</span>article<span class=\"token punctuation\">)</span>\n    expire_cache_for<span class=\"token punctuation\">(</span>article<span class=\"token punctuation\">)</span>\n    expire_cache_for_single<span class=\"token punctuation\">(</span>article<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token comment\"># If our sweeper detects that a article was deleted call this</span>\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">after_destroy</span></span><span class=\"token punctuation\">(</span>article<span class=\"token punctuation\">)</span>\n    expire_cache_for<span class=\"token punctuation\">(</span>article<span class=\"token punctuation\">)</span>\n    expire_cache_for_single<span class=\"token punctuation\">(</span>article<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token keyword\">private</span>\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">expire_cache_for_single</span></span><span class=\"token punctuation\">(</span>article<span class=\"token punctuation\">)</span>\n    expire_page<span class=\"token punctuation\">(</span><span class=\"token symbol\">:controller</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">'articles'</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:action</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">'show'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">expire_cache_for</span></span><span class=\"token punctuation\">(</span>article<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># Expire the index page now that we added or modified an article</span>\n    expire_page<span class=\"token punctuation\">(</span><span class=\"token symbol\">:controller</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">'articles'</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:action</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">'index'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># expire the index.html which is created by root_path</span>\n    expire_page <span class=\"token string\">'/index.html'</span>\n\n    <span class=\"token comment\"># manually remove pages(1.html, 2.html, etc)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span>exist<span class=\"token operator\">?</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span><span class=\"token constant\">Rails</span><span class=\"token punctuation\">.</span>root<span class=\"token delimiter tag\">}</span></span>/public/articles/page\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># check to make sure directory exists</span>\n      <span class=\"token builtin\">Dir</span><span class=\"token punctuation\">.</span>foreach<span class=\"token punctuation\">(</span><span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span><span class=\"token constant\">Rails</span><span class=\"token punctuation\">.</span>root<span class=\"token delimiter tag\">}</span></span>/public/articles/page\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>entry<span class=\"token operator\">|</span>\n        <span class=\"token keyword\">unless</span> entry <span class=\"token operator\">==</span> <span class=\"token string\">\".\"</span> <span class=\"token operator\">||</span> entry <span class=\"token operator\">==</span> <span class=\"token string\">\"..\"</span> <span class=\"token operator\">||</span> entry <span class=\"token operator\">==</span> <span class=\"token string\">\".gitignore\"</span> <span class=\"token comment\"># ignore dot files</span>\n          <span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span>delete<span class=\"token punctuation\">(</span><span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span><span class=\"token constant\">Rails</span><span class=\"token punctuation\">.</span>root<span class=\"token delimiter tag\">}</span></span>/public/articles/page/<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span>entry<span class=\"token delimiter tag\">}</span></span>\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">end</span>\n      <span class=\"token keyword\">end</span>\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>","fields":{"slug":"/articles/pagination-and-page-cache-sweepers-in-rails-3","tagSlugs":["/tag/code/","/tag/ruby-on-rails/"]},"frontmatter":{"date":"2011-10-15","description":null,"tags":["Code","Ruby on Rails"],"title":"Pagination and page cache sweepers in Rails 3"}}},"pageContext":{"slug":"/articles/pagination-and-page-cache-sweepers-in-rails-3"}},"staticQueryHashes":["1251057998","251939775","401334301"]}